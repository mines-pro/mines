<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Mines Game</title>

<!-- Firebase Compat SDK (loads synchronously, no module timing issues) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: Arial;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    min-height: 100vh;
    padding: 10px;
}
.login-screen {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}
.login-box {
    background: white;
    padding: 40px;
    border-radius: 20px;
    max-width: 400px;
    width: 100%;
}
.login-title { font-size: 32px; font-weight: bold; text-align: center; margin-bottom: 30px; }
.login-input {
    width: 100%;
    padding: 15px;
    margin: 15px 0;
    border: 2px solid #ddd;
    border-radius: 10px;
    font-size: 16px;
}
.login-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
}
.container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    padding: 20px;
    display: none;
}
.container.active { display: block; }
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
}
h1 { color: #1e3c72; font-size: 28px; }
.logout-btn {
    background: #DC143C;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
}
.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}
.stat-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
}
.stat-value { font-size: 36px; font-weight: bold; margin: 10px 0; }
.stat-label { font-size: 14px; }
.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}
.tab {
    padding: 12px 24px;
    background: #1e3c72;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
}
.tab.active { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.card {
    background: white;
    border: 2px solid #eee;
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
}
.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    flex-wrap: wrap;
    gap: 10px;
}
.card-title { font-weight: bold; font-size: 16px; }
.card-info { color: #666; font-size: 14px; margin: 5px 0; }
.card-amount { font-size: 24px; font-weight: bold; color: #4CAF50; margin: 10px 0; }
button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    margin: 2px;
}
.btn-approve { background: #4CAF50; color: white; }
.btn-reject  { background: #f44336; color: white; }
.btn-delete  { background: #FF9800; color: white; }
.btn-edit    { background: #2196F3; color: white; }
.btn-kick    { background: #9C27B0; color: white; }
.status-pending  { color: #FF9800; background: rgba(255,152,0,0.15);  padding: 5px 10px; border-radius: 5px; font-size: 12px; }
.status-approved { color: #4CAF50; background: rgba(76,175,80,0.15);  padding: 5px 10px; border-radius: 5px; font-size: 12px; }
.status-rejected { color: #f44336; background: rgba(244,67,54,0.15);  padding: 5px 10px; border-radius: 5px; font-size: 12px; }
.status-online   { color: #4CAF50; background: rgba(76,175,80,0.15);  padding: 4px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; }
.status-offline  { color: #999;    background: rgba(150,150,150,0.15); padding: 4px 10px; border-radius: 5px; font-size: 12px; }
.modal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
.modal.active { display: flex; }
.modal-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}
.modal-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; }
.modal-input {
    width: 100%;
    padding: 12px;
    margin: 12px 0;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
}
.no-data { text-align: center; padding: 40px; color: #999; font-size: 16px; }
.player-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 15px;
    border-radius: 10px;
    margin: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.player-name    { font-size: 18px; font-weight: bold; }
.player-phone   { font-size: 14px; opacity: 0.9; }
.player-balance { font-size: 24px; font-weight: bold; }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ -->
<div id="loginScreen" class="login-screen">
    <div class="login-box">
        <div class="login-title">üîê Admin Login</div>
        <input type="password" id="adminPassword" class="login-input" placeholder="Enter Password" onkeydown="if(event.key==='Enter')adminLogin()">
        <button class="login-btn" onclick="adminLogin()">LOGIN</button>
    </div>
</div>

<!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
<div id="dashboard" class="container">
    <div class="header">
        <h1>üéÆ Admin Dashboard</h1>
        <button class="logout-btn" onclick="adminLogout()">Logout</button>
    </div>

    <div class="stats">
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea, #764ba2);">
            <div class="stat-label">Total Users</div>
            <div class="stat-value" id="totalUsers">0</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
            <div class="stat-label">Total Withdrawals</div>
            <div class="stat-value">Rs <span id="totalWithdrawals">0</span></div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('players', this)">üë• Players</button>
        <button class="tab"        onclick="showTab('users', this)">üìã Users</button>
        <button class="tab"        onclick="showTab('deposits', this)">üí∞ Deposits</button>
        <button class="tab"        onclick="showTab('withdraws', this)">üí∏ Withdrawals</button>
    </div>

    <div id="players" class="tab-content active">
        <h2 style="margin-bottom:15px;">Live Balances</h2>
        <div id="playersContent"><div class="no-data">Loading‚Ä¶</div></div>
    </div>
    <div id="users" class="tab-content">
        <h2 style="margin-bottom:15px;">All Users & Login Verify</h2>
        <div id="usersContent"><div class="no-data">Loading‚Ä¶</div></div>
    </div>
    <div id="deposits" class="tab-content">
        <h2 style="margin-bottom:15px;">Deposit Requests</h2>
        <div id="depositsContent"><div class="no-data">Loading‚Ä¶</div></div>
    </div>
    <div id="withdraws" class="tab-content">
        <h2 style="margin-bottom:15px;">Withdrawal Requests</h2>
        <div id="withdrawsContent"><div class="no-data">Loading‚Ä¶</div></div>
    </div>
</div>

<!-- ‚îÄ‚îÄ EDIT BALANCE MODAL ‚îÄ‚îÄ -->
<div id="editBalanceModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">Edit Balance</div>
        <p><strong>User:</strong> <span id="editUserName"></span></p>
        <p><strong>Phone:</strong> <span id="editUserPhone"></span></p>
        <p><strong>Current:</strong> Rs <span id="editCurrentBalance"></span></p>
        <input type="number" id="editNewBalance" class="modal-input" placeholder="New balance">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-approve" style="flex:1;" onclick="saveBalance()">Save</button>
            <button class="btn-reject"  style="flex:1;" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- ============================================================
     MAIN SCRIPT  ‚Äì  Firebase compat is already loaded above,
     so firebase.app() / firebase.database() work instantly.
     ============================================================ -->
<script>
// ‚îÄ‚îÄ Firebase init (compat SDK ‚Äì synchronous, no module issues) ‚îÄ‚îÄ
const firebaseConfig = {
    apiKey:                "AIzaSyA8C1-TpsRo0UsATshlI8Dy0v40PnLRlc4",
    authDomain:            "mines-67d8c.firebaseapp.com",
    databaseURL:           "https://mines-67d8c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId:             "mines-67d8c",
    storageBucket:         "mines-67d8c.firebasestorage.app",
    messagingSenderId:     "918317634273",
    appId:                 "1:918317634273:web:8527c0d58a1f3de0371da0",
    measurementId:         "G-NHC6K1X3KZ"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
console.log('‚úÖ Firebase (compat) initialized!');

// ‚îÄ‚îÄ Globals ‚îÄ‚îÄ
const ADMIN_PASSWORD = 'admin123';
let currentEditUser  = null;

// ============================================================
// LOGIN / LOGOUT
// ============================================================
function adminLogin() {
    const password = document.getElementById('adminPassword').value;
    if (password === ADMIN_PASSWORD) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        setupRealTimeListeners();   // onValue handles initial load too
        updateStats();
    } else {
        alert('‚ùå Wrong password!');
    }
}

function adminLogout() {
    if (confirm('Logout?')) location.reload();
}

// ============================================================
// REAL-TIME LISTENERS  (fire immediately with current data)
// ============================================================
function setupRealTimeListeners() {
    db.ref('users').on('value', () => {
        loadPlayers();
        loadUsers();
        updateStats();
    });

    db.ref('depositRequests').on('value', () => {
        loadDeposits();
    });

    db.ref('withdrawRequests').on('value', () => {
        loadWithdraws();
        updateStats();
    });
}

// ============================================================
// PLAYERS TAB ‚Äì Live Balances
// ============================================================
async function loadPlayers() {
    try {
        const snapshot = await db.ref('users').once('value');
        const content  = document.getElementById('playersContent');

        if (!snapshot.exists()) {
            content.innerHTML = '<div class="no-data">No players yet</div>';
            return;
        }

        const users = snapshot.val();
        let arr = Object.entries(users).map(([phone, data]) => ({
            phone,
            name:     data.name || 'Unknown',
            balance:  data.balance || 0,
            isOnline: !!data.isOnline
        }));
        arr.sort((a, b) => b.balance - a.balance);

        let html = '';
        arr.forEach(u => {
            const tag = u.isOnline
                ? '<span class="status-online">‚óè ONLINE</span>'
                : '<span class="status-offline">‚óè Offline</span>';
            html += `
                <div class="player-card">
                    <div>
                        <div class="player-name">${u.name} ${tag}</div>
                        <div class="player-phone">üì± ${u.phone}</div>
                    </div>
                    <div class="player-balance">Rs ${u.balance.toFixed(0)}</div>
                </div>`;
        });

        content.innerHTML = html;
        console.log('‚úÖ Players loaded:', arr.length);
    } catch (e) {
        console.error('loadPlayers error:', e);
        document.getElementById('playersContent').innerHTML = '<div class="no-data">Error loading players</div>';
    }
}

// ============================================================
// USERS TAB ‚Äì All Users + Login Verify + Kick
// ============================================================
async function loadUsers() {
    try {
        const snapshot = await db.ref('users').once('value');
        const content  = document.getElementById('usersContent');

        if (!snapshot.exists()) {
            content.innerHTML = '<div class="no-data">No users yet</div>';
            return;
        }

        const users = snapshot.val();
        let html = '';

        Object.entries(users).forEach(([phone, u]) => {
            const tag = u.isOnline
                ? '<span class="status-online">‚óè ONLINE</span>'
                : '<span class="status-offline">‚óè Offline</span>';

            const devInfo   = u.deviceId
                ? `<div class="card-info">üì± Device: ${u.deviceId.substring(0,16)}‚Ä¶</div>`
                : '<div class="card-info">üì± Device: N/A</div>';

            const loginInfo = u.lastLogin
                ? `<div class="card-info">üïí Last Login: ${new Date(u.lastLogin).toLocaleString()}</div>`
                : '';

            const kickBtn   = u.isOnline
                ? `<button class="btn-kick" onclick="kickUser('${phone}')">‚ö° Kick</button>`
                : '';

            html += `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${u.name || 'Unknown'} ${tag}</div>
                            <div class="card-info">üì± ${phone}</div>
                            ${devInfo}
                            ${loginInfo}
                        </div>
                        <div>
                            <button class="btn-edit" onclick="editBalance('${phone}','${(u.name||'').replace(/'/g,"\\'")}',${u.balance||0})">Edit Balance</button>
                            ${kickBtn}
                        </div>
                    </div>
                    <div class="card-amount">Rs ${(u.balance||0).toFixed(0)}</div>
                    <div class="card-info">Deposit: Rs ${(u.totalDeposit||0).toFixed(0)} | Withdraw: Rs ${(u.totalWithdraw||0).toFixed(0)}</div>
                </div>`;
        });

        content.innerHTML = html;
        console.log('‚úÖ Users loaded');
    } catch (e) {
        console.error('loadUsers error:', e);
        document.getElementById('usersContent').innerHTML = '<div class="no-data">Error loading users</div>';
    }
}

// ============================================================
// KICK USER
// ============================================================
async function kickUser(phone) {
    if (!confirm(`Kick user ${phone} off all devices?`)) return;
    try {
        await db.ref(`users/${phone}`).update({
            isOnline: false,
            deviceId: null,
            kickedAt: Date.now()
        });
        alert('‚úÖ User kicked!');
    } catch (e) {
        console.error(e);
        alert('‚ùå Error kicking user!');
    }
}

// ============================================================
// DEPOSITS TAB
// ============================================================
async function loadDeposits() {
    try {
        const snapshot = await db.ref('depositRequests').once('value');
        const content  = document.getElementById('depositsContent');

        if (!snapshot.exists()) {
            content.innerHTML = '<div class="no-data">No deposits yet</div>';
            return;
        }

        let arr = [];
        snapshot.forEach(child => {
            arr.push({ firebaseKey: child.key, ...child.val() });
        });
        arr.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        let html = '';
        arr.forEach(d => {
            const date  = d.timestamp ? new Date(d.timestamp).toLocaleString() : 'N/A';
            const sClass = d.status === 'pending' ? 'status-pending' :
                           d.status === 'approved' ? 'status-approved' : 'status-rejected';
            html += `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${d.name || 'Unknown'}</div>
                            <div class="card-info">üì± ${d.phone}</div>
                            <div class="card-info">üïí ${date}</div>
                        </div>
                        <span class="${sClass}">${(d.status||'pending').toUpperCase()}</span>
                    </div>
                    <div class="card-amount">Rs ${d.amount}</div>
                    ${d.status === 'pending' ? `
                        <div style="margin-top:10px;">
                            <button class="btn-approve" onclick="approveDeposit('${d.firebaseKey}','${d.phone}',${d.amount})">‚úì Approve</button>
                            <button class="btn-reject"  onclick="rejectDeposit('${d.firebaseKey}')">‚úó Reject</button>
                        </div>` : `
                        <div style="margin-top:10px;">
                            <button class="btn-delete" onclick="deleteDeposit('${d.firebaseKey}')">üóë Delete</button>
                        </div>`}
                </div>`;
        });

        content.innerHTML = html;
    } catch (e) {
        console.error('loadDeposits error:', e);
    }
}

// ============================================================
// WITHDRAWALS TAB
// ============================================================
async function loadWithdraws() {
    try {
        const snapshot = await db.ref('withdrawRequests').once('value');
        const content  = document.getElementById('withdrawsContent');

        if (!snapshot.exists()) {
            content.innerHTML = '<div class="no-data">No withdrawals yet</div>';
            return;
        }

        let arr = [];
        snapshot.forEach(child => {
            arr.push({ firebaseKey: child.key, ...child.val() });
        });
        arr.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        let html = '';
        arr.forEach(w => {
            const date  = w.timestamp ? new Date(w.timestamp).toLocaleString() : 'N/A';
            const sClass = w.status === 'pending' ? 'status-pending' :
                           w.status === 'approved' ? 'status-approved' : 'status-rejected';
            html += `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${w.name || 'Unknown'}</div>
                            <div class="card-info">üì± ${w.phone}</div>
                            <div class="card-info">üí∞ JazzCash: ${w.jazzCash}</div>
                            <div class="card-info">üïí ${date}</div>
                        </div>
                        <span class="${sClass}">${(w.status||'pending').toUpperCase()}</span>
                    </div>
                    <div class="card-amount">Rs ${w.amount}</div>
                    ${w.status === 'pending' ? `
                        <div style="margin-top:10px;">
                            <button class="btn-approve" onclick="approveWithdraw('${w.firebaseKey}','${w.phone}',${w.amount})">‚úì Approve</button>
                            <button class="btn-reject"  onclick="rejectWithdraw('${w.firebaseKey}')">‚úó Reject</button>
                        </div>` : `
                        <div style="margin-top:10px;">
                            <button class="btn-delete" onclick="deleteWithdraw('${w.firebaseKey}')">üóë Delete</button>
                        </div>`}
                </div>`;
        });

        content.innerHTML = html;
    } catch (e) {
        console.error('loadWithdraws error:', e);
    }
}

// ============================================================
// STATS ‚Äì Total Users & Total Withdrawals
// ============================================================
async function updateStats() {
    try {
        const usersSnap    = await db.ref('users').once('value');
        const withdrawSnap = await db.ref('withdrawRequests').once('value');

        const totalUsers = usersSnap.exists() ? Object.keys(usersSnap.val()).length : 0;

        let totalWithdrawals = 0;
        if (withdrawSnap.exists()) {
            withdrawSnap.forEach(child => {
                const w = child.val();
                if (w.status === 'approved') totalWithdrawals += (w.amount || 0);
            });
        }

        document.getElementById('totalUsers').textContent       = totalUsers;
        document.getElementById('totalWithdrawals').textContent = totalWithdrawals.toFixed(0);
        console.log('‚úÖ Stats ‚Äì Users:', totalUsers, '| Withdrawals:', totalWithdrawals);
    } catch (e) {
        console.error('updateStats error:', e);
    }
}

// ============================================================
// DEPOSIT ACTIONS
// ============================================================
async function approveDeposit(key, phone, amount) {
    if (!confirm('Approve this deposit? Balance will be credited.')) return;
    try {
        const snap = await db.ref(`users/${phone}`).once('value');
        if (snap.exists()) {
            const u = snap.val();
            await db.ref(`users/${phone}`).update({
                balance:      (u.balance || 0) + amount,
                totalDeposit: (u.totalDeposit || 0) + amount
            });
        }
        await db.ref(`depositRequests/${key}`).update({ status: 'approved', approvedAt: Date.now() });
        alert('‚úÖ Deposit approved!');
    } catch (e) { console.error(e); alert('‚ùå Error!'); }
}

async function rejectDeposit(key) {
    if (!confirm('Reject this deposit?')) return;
    try {
        await db.ref(`depositRequests/${key}`).update({ status: 'rejected' });
        alert('Deposit rejected');
    } catch (e) { console.error(e); }
}

async function deleteDeposit(key) {
    if (!confirm('Delete this deposit request?')) return;
    try {
        await db.ref(`depositRequests/${key}`).remove();
        alert('‚úÖ Deleted!');
    } catch (e) { console.error(e); }
}

// ============================================================
// WITHDRAWAL ACTIONS
// ============================================================
async function approveWithdraw(key, phone, amount) {
    if (!confirm('Step 1: Have you sent money to user?')) return;
    if (!confirm('Step 2: Confirm approval?'))           return;
    try {
        const snap = await db.ref(`users/${phone}`).once('value');
        if (snap.exists()) {
            const u = snap.val();
            await db.ref(`users/${phone}`).update({
                balance:       Math.max(0, (u.balance || 0) - amount),
                totalWithdraw: (u.totalWithdraw || 0) + amount
            });
        }
        await db.ref(`withdrawRequests/${key}`).update({ status: 'approved', approvedAt: Date.now() });
        alert('‚úÖ Withdrawal approved!');
    } catch (e) { console.error(e); alert('‚ùå Error!'); }
}

async function rejectWithdraw(key) {
    if (!confirm('Reject this withdrawal?')) return;
    try {
        await db.ref(`withdrawRequests/${key}`).update({ status: 'rejected' });
        alert('Withdrawal rejected');
    } catch (e) { console.error(e); }
}

async function deleteWithdraw(key) {
    if (!confirm('Delete this withdrawal request?')) return;
    try {
        await db.ref(`withdrawRequests/${key}`).remove();
        alert('‚úÖ Deleted!');
    } catch (e) { console.error(e); }
}

// ============================================================
// EDIT BALANCE MODAL
// ============================================================
function editBalance(phone, name, balance) {
    currentEditUser = phone;
    document.getElementById('editUserName').textContent       = name;
    document.getElementById('editUserPhone').textContent      = phone;
    document.getElementById('editCurrentBalance').textContent = Number(balance).toFixed(0);
    document.getElementById('editNewBalance').value           = Number(balance).toFixed(0);
    document.getElementById('editBalanceModal').classList.add('active');
}

async function saveBalance() {
    const val = parseFloat(document.getElementById('editNewBalance').value);
    if (isNaN(val) || val < 0) { alert('Invalid balance!'); return; }
    try {
        await db.ref(`users/${currentEditUser}`).update({ balance: val });
        alert('‚úÖ Balance updated!');
        closeModal();
    } catch (e) { console.error(e); alert('‚ùå Error!'); }
}

function closeModal() {
    document.getElementById('editBalanceModal').classList.remove('active');
}

// ============================================================
// TAB SWITCHING
// ============================================================
function showTab(tabName, btn) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(tabName).classList.add('active');
}
</script>

</body>
</html>
