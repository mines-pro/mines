<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Mines Game</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: Arial;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    min-height: 100vh;
    padding: 10px;
}
.login-screen {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}
.login-box {
    background: white;
    padding: 40px;
    border-radius: 20px;
    max-width: 400px;
    width: 100%;
}
.login-title { font-size: 32px; font-weight: bold; text-align: center; margin-bottom: 30px; }
.login-input {
    width: 100%;
    padding: 15px;
    margin: 15px 0;
    border: 2px solid #ddd;
    border-radius: 10px;
    font-size: 16px;
}
.login-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
}
.container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    padding: 20px;
    display: none;
}
.container.active { display: block; }
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
}
h1 { color: #1e3c72; font-size: 28px; }
.logout-btn {
    background: #DC143C;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
}
.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}
.stat-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
}
.stat-value { font-size: 36px; font-weight: bold; margin: 10px 0; }
.stat-label { font-size: 14px; }
.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}
.tab {
    padding: 12px 24px;
    background: #1e3c72;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
}
.tab.active { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.card {
    background: white;
    border: 2px solid #eee;
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
}
.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    flex-wrap: wrap;
    gap: 10px;
}
.card-title { font-weight: bold; font-size: 16px; }
.card-info { color: #666; font-size: 14px; margin: 5px 0; }
.card-amount { font-size: 24px; font-weight: bold; color: #4CAF50; margin: 10px 0; }
button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    margin: 2px;
}
.btn-approve { background: #4CAF50; color: white; }
.btn-reject { background: #f44336; color: white; }
.btn-edit { background: #2196F3; color: white; }
.status-pending { color: #FF9800; background: rgba(255,152,0,0.15); padding: 5px 10px; border-radius: 5px; font-size: 12px; }
.status-approved { color: #4CAF50; background: rgba(76,175,80,0.15); padding: 5px 10px; border-radius: 5px; font-size: 12px; }
.screenshot { max-width: 200px; border-radius: 8px; cursor: pointer; }
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
.modal.active { display: flex; }
.modal-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    max-width: 500px;
    width: 90%;
}
.modal-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; }
.modal-input {
    width: 100%;
    padding: 12px;
    margin: 12px 0;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
}
.no-data { text-align: center; padding: 40px; color: #999; }
</style>
</head>
<body>

<div id="loginScreen" class="login-screen">
    <div class="login-box">
        <div class="login-title">üîê Admin Login</div>
        <input type="password" id="adminPassword" class="login-input" placeholder="Enter Password">
        <button class="login-btn" onclick="adminLogin()">LOGIN</button>
    </div>
</div>

<div id="dashboard" class="container">
    <div class="header">
        <h1>üéÆ Admin Dashboard</h1>
        <button class="logout-btn" onclick="adminLogout()">Logout</button>
    </div>

    <div class="stats">
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea, #764ba2);">
            <div class="stat-label">Total Users</div>
            <div class="stat-value" id="totalUsers">0</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
            <div class="stat-label">Pending Deposits</div>
            <div class="stat-value" id="pendingDeposits">0</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
            <div class="stat-label">Pending Withdrawals</div>
            <div class="stat-value" id="pendingWithdraws">0</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
            <div class="stat-label">Total Balance</div>
            <div class="stat-value">Rs <span id="totalBalance">0</span></div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('users')">üë• Users</button>
        <button class="tab" onclick="showTab('deposits')">üí∞ Deposits</button>
        <button class="tab" onclick="showTab('withdraws')">üí∏ Withdrawals</button>
    </div>

    <div id="users" class="tab-content active">
        <h2 style="margin-bottom: 15px;">All Users</h2>
        <div id="usersContent"></div>
    </div>

    <div id="deposits" class="tab-content">
        <h2 style="margin-bottom: 15px;">Deposit Requests</h2>
        <div id="depositsContent"></div>
    </div>

    <div id="withdraws" class="tab-content">
        <h2 style="margin-bottom: 15px;">Withdrawal Requests</h2>
        <div id="withdrawsContent"></div>
    </div>
</div>

<div id="editBalanceModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">Edit Balance</div>
        <p><strong>User:</strong> <span id="editUserName"></span></p>
        <p><strong>Phone:</strong> <span id="editUserPhone"></span></p>
        <p><strong>Current:</strong> Rs <span id="editCurrentBalance"></span></p>
        <input type="number" id="editNewBalance" class="modal-input" placeholder="New balance">
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-approve" style="flex: 1;" onclick="saveBalance()">Save</button>
            <button class="btn-reject" style="flex: 1;" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>

<div id="screenshotModal" class="modal" onclick="closeModal()">
    <div class="modal-content" style="max-width: 90%;">
        <img id="screenshotImg" style="width: 100%; border-radius: 10px;">
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
const ADMIN_PASSWORD = '@/Aa14324300'; // CHANGE THIS!

const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT.firebaseio.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_ID",
    appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let currentEditUser = null;

function adminLogin() {
    if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        sessionStorage.setItem('adminLoggedIn', 'true');
        loadAllData();
    } else {
        alert('Incorrect password!');
    }
}

function adminLogout() {
    if (confirm('Logout?')) {
        sessionStorage.removeItem('adminLoggedIn');
        location.reload();
    }
}

window.onload = function() {
    if (sessionStorage.getItem('adminLoggedIn')) {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        loadAllData();
    }
};

async function loadAllData() {
    await loadUsers();
    await loadDeposits();
    await loadWithdraws();
    await loadStats();
}

async function loadStats() {
    try {
        const usersSnapshot = await database.ref('users').once('value');
        const depositsSnapshot = await database.ref('depositRequests').once('value');
        const withdrawsSnapshot = await database.ref('withdrawRequests').once('value');
        
        let totalUsers = 0;
        let totalBalance = 0;
        let pendingDep = 0;
        let pendingWith = 0;
        
        usersSnapshot.forEach(child => {
            totalUsers++;
            totalBalance += child.val().balance || 0;
        });
        
        depositsSnapshot.forEach(child => {
            if (child.val().status === 'pending') pendingDep++;
        });
        
        withdrawsSnapshot.forEach(child => {
            if (child.val().status === 'pending') pendingWith++;
        });
        
        document.getElementById('totalUsers').textContent = totalUsers;
        document.getElementById('totalBalance').textContent = totalBalance.toFixed(2);
        document.getElementById('pendingDeposits').textContent = pendingDep;
        document.getElementById('pendingWithdraws').textContent = pendingWith;
    } catch (error) {
        console.error('Stats error:', error);
    }
}

async function loadUsers() {
    try {
        const snapshot = await database.ref('users').once('value');
        const content = document.getElementById('usersContent');
        
        if (!snapshot.exists()) {
            content.innerHTML = '<div class="no-data">No users yet</div>';
            return;
        }
        
        let html = '';
        snapshot.forEach(child => {
            const user = child.val();
            html += `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${user.name}</div>
                            <div class="card-info">üì± ${user.phone}</div>
                        </div>
                        <button class="btn-edit" onclick="editBalance('${child.key}', '${user.name}', '${user.phone}', ${user.balance || 0})">
                            Edit Balance
                        </button>
                    </div>
                    <div class="card-amount">Rs ${(user.balance || 0).toFixed(2)}</div>
                    <div class="card-info">Deposit: Rs ${(user.totalDeposit || 0).toFixed(2)} | Withdraw: Rs ${(user.totalWithdraw || 0).toFixed(2)}</div>
                </div>
            `;
        });
        
        content.innerHTML = html;
    } catch (error) {
        console.error('Users error:', error);
    }
}

async function loadDeposits() {
    try {
        const snapshot = await database.ref('depositRequests').orderByChild('timestamp').once('value');
        const content = document.getElementById('depositsContent');
        
        if (!snapshot.exists()) {
            content.innerHTML = '<div class="no-data">No deposits yet</div>';
            return;
        }
        
        let html = '';
        let deposits = [];
        snapshot.forEach(child => {
            deposits.push({ key: child.key, ...child.val() });
        });
        
        deposits.reverse().forEach(dep => {
            const date = new Date(dep.timestamp).toLocaleString();
            const statusClass = dep.status === 'pending' ? 'status-pending' : 'status-approved';
            
            html += `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${dep.name}</div>
                            <div class="card-info">üì± ${dep.phone}</div>
                            <div class="card-info">üïí ${date}</div>
                        </div>
                        <span class="${statusClass}">${dep.status.toUpperCase()}</span>
                    </div>
                    <div class="card-amount">Rs ${dep.amount}</div>
                    ${dep.screenshotUrl ? `
                        <img src="${dep.screenshotUrl}" class="screenshot" onclick="viewScreenshot('${dep.screenshotUrl}')">
                    ` : ''}
                    ${dep.status === 'pending' ? `
                        <div style="margin-top: 10px;">
                            <button class="btn-approve" onclick="approveDeposit('${dep.key}', ${dep.amount}, '${dep.userId}')">‚úì Approve</button>
                            <button class="btn-reject" onclick="rejectDeposit('${dep.key}')">‚úó Reject</button>
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        content.innerHTML = html;
    } catch (error) {
        console.error('Deposits error:', error);
    }
}

async function loadWithdraws() {
    try {
        const snapshot = await database.ref('withdrawRequests').orderByChild('timestamp').once('value');
        const content = document.getElementById('withdrawsContent');
        
        if (!snapshot.exists()) {
            content.innerHTML = '<div class="no-data">No withdrawals yet</div>';
            return;
        }
        
        let html = '';
        let withdraws = [];
        snapshot.forEach(child => {
            withdraws.push({ key: child.key, ...child.val() });
        });
        
        withdraws.reverse().forEach(wit => {
            const date = new Date(wit.timestamp).toLocaleString();
            const statusClass = wit.status === 'pending' ? 'status-pending' : 'status-approved';
            
            html += `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${wit.name}</div>
                            <div class="card-info">üì± ${wit.phone}</div>
                            <div class="card-info">üí∞ JazzCash: ${wit.jazzCash}</div>
                            <div class="card-info">üïí ${date}</div>
                        </div>
                        <span class="${statusClass}">${wit.status.toUpperCase()}</span>
                    </div>
                    <div class="card-amount">Rs ${wit.amount}</div>
                    ${wit.status === 'pending' ? `
                        <div style="margin-top: 10px;">
                            <button class="btn-approve" onclick="approveWithdraw('${wit.key}', ${wit.amount}, '${wit.userId}')">‚úì Approve</button>
                            <button class="btn-reject" onclick="rejectWithdraw('${wit.key}')">‚úó Reject</button>
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        content.innerHTML = html;
    } catch (error) {
        console.error('Withdraws error:', error);
    }
}

async function approveDeposit(key, amount, userId) {
    if (!confirm('Approve this deposit?')) return;
    
    try {
        const userRef = database.ref('users/' + userId);
        const snapshot = await userRef.once('value');
        const currentBalance = snapshot.val().balance || 0;
        const currentDeposit = snapshot.val().totalDeposit || 0;
        
        await userRef.update({
            balance: currentBalance + amount,
            totalDeposit: currentDeposit + amount
        });
        
        await database.ref('depositRequests/' + key).update({
            status: 'approved',
            approvedAt: Date.now()
        });
        
        alert('‚úÖ Deposit approved!');
        loadAllData();
    } catch (error) {
        console.error('Approve error:', error);
        alert('Error approving');
    }
}

async function rejectDeposit(key) {
    if (!confirm('Reject this deposit?')) return;
    
    try {
        await database.ref('depositRequests/' + key).update({
            status: 'rejected',
            rejectedAt: Date.now()
        });
        
        alert('Deposit rejected');
        loadAllData();
    } catch (error) {
        console.error('Reject error:', error);
    }
}

async function approveWithdraw(key, amount, userId) {
    if (!confirm('Step 1: Have you sent money to user?')) return;
    if (!confirm('Step 2: Confirm approval? Balance will be deducted.')) return;
    
    try {
        const userRef = database.ref('users/' + userId);
        const snapshot = await userRef.once('value');
        const currentBalance = snapshot.val().balance || 0;
        const currentWithdraw = snapshot.val().totalWithdraw || 0;
        
        await userRef.update({
            balance: currentBalance - amount,
            totalWithdraw: currentWithdraw + amount
        });
        
        await database.ref('withdrawRequests/' + key).update({
            status: 'approved',
            approvedAt: Date.now()
        });
        
        alert('‚úÖ Withdrawal approved!');
        loadAllData();
    } catch (error) {
        console.error('Approve error:', error);
        alert('Error approving');
    }
}

async function rejectWithdraw(key) {
    if (!confirm('Reject this withdrawal?')) return;
    
    try {
        await database.ref('withdrawRequests/' + key).update({
            status: 'rejected',
            rejectedAt: Date.now()
        });
        
        alert('Withdrawal rejected');
        loadAllData();
    } catch (error) {
        console.error('Reject error:', error);
    }
}

function editBalance(userId, name, phone, balance) {
    currentEditUser = userId;
    document.getElementById('editUserName').textContent = name;
    document.getElementById('editUserPhone').textContent = phone;
    document.getElementById('editCurrentBalance').textContent = balance.toFixed(2);
    document.getElementById('editNewBalance').value = balance.toFixed(2);
    document.getElementById('editBalanceModal').classList.add('active');
}

async function saveBalance() {
    const newBalance = parseFloat(document.getElementById('editNewBalance').value);
    
    if (isNaN(newBalance) || newBalance < 0) {
        alert('Invalid balance!');
        return;
    }
    
    try {
        await database.ref('users/' + currentEditUser + '/balance').set(newBalance);
        alert('‚úÖ Balance updated!');
        closeModal();
        loadAllData();
    } catch (error) {
        console.error('Update error:', error);
        alert('Error updating');
    }
}

function viewScreenshot(url) {
    document.getElementById('screenshotImg').src = url;
    document.getElementById('screenshotModal').classList.add('active');
}

function closeModal() {
    document.getElementById('editBalanceModal').classList.remove('active');
    document.getElementById('screenshotModal').classList.remove('active');
}

function showTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
}

setInterval(loadAllData, 30000);
</script>

</body>
</html>
