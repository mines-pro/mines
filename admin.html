<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Mines Game</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: Arial;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    min-height: 100vh;
    padding: 10px;
}
.login-screen {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}
.login-box {
    background: white;
    padding: 40px;
    border-radius: 20px;
    max-width: 400px;
    width: 100%;
}
.login-title { font-size: 32px; font-weight: bold; text-align: center; margin-bottom: 30px; }
.login-input {
    width: 100%;
    padding: 15px;
    margin: 15px 0;
    border: 2px solid #ddd;
    border-radius: 10px;
    font-size: 16px;
}
.login-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
}
.container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    padding: 20px;
    display: none;
}
.container.active { display: block; }
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 10px;
}
h1 { color: #1e3c72; font-size: 28px; }
.logout-btn {
    background: #DC143C;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
}
.stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}
.stat-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px;
    border-radius: 15px;
    text-align: center;
    cursor: pointer;
    transition: transform 0.2s;
}
.stat-card:hover { transform: translateY(-3px); }
.stat-value { font-size: 36px; font-weight: bold; margin: 10px 0; }
.stat-label { font-size: 14px; }
.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}
.tab {
    padding: 12px 24px;
    background: #1e3c72;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
}
.tab.active { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.card {
    background: white;
    border: 2px solid #eee;
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
}
.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    flex-wrap: wrap;
    gap: 10px;
}
.card-title { font-weight: bold; font-size: 16px; }
.card-info { color: #666; font-size: 14px; margin: 5px 0; }
.card-amount { font-size: 24px; font-weight: bold; color: #4CAF50; margin: 10px 0; }
button {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    margin: 2px;
}
.btn-approve { background: #4CAF50; color: white; }
.btn-reject { background: #f44336; color: white; }
.btn-edit { background: #2196F3; color: white; }
.btn-delete { background: #FF9800; color: white; }
.status-pending { color: #FF9800; background: rgba(255,152,0,0.15); padding: 5px 10px; border-radius: 5px; font-size: 12px; }
.status-approved { color: #4CAF50; background: rgba(76,175,80,0.15); padding: 5px 10px; border-radius: 5px; font-size: 12px; }
.status-rejected { color: #f44336; background: rgba(244,67,54,0.15); padding: 5px 10px; border-radius: 5px; font-size: 12px; }
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
    z-index: 1000;
}
.modal.active { display: flex; }
.modal-content {
    background: white;
    padding: 30px;
    border-radius: 20px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}
.modal-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; }
.modal-input {
    width: 100%;
    padding: 12px;
    margin: 12px 0;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
}
.no-data { text-align: center; padding: 40px; color: #999; }
.players-list {
    max-height: 600px;
    overflow-y: auto;
}
.player-card {
    background: #f5f5f5;
    padding: 15px;
    margin: 10px 0;
    border-radius: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.player-info { flex: 1; }
.player-name { font-weight: bold; font-size: 16px; color: #1e3c72; }
.player-phone { color: #666; font-size: 14px; margin-top: 5px; }
.player-balance {
    font-size: 24px;
    font-weight: bold;
    color: #FFD700;
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    padding: 10px 20px;
    border-radius: 8px;
}
</style>
</head>
<body>

<div id="loginScreen" class="login-screen">
    <div class="login-box">
        <div class="login-title">üîê Admin Login</div>
        <input type="password" id="adminPassword" class="login-input" placeholder="Enter Password">
        <button class="login-btn" onclick="adminLogin()">LOGIN</button>
    </div>
</div>

<div id="dashboard" class="container">
    <div class="header">
        <h1>üéÆ Admin Dashboard</h1>
        <div style="display: flex; gap: 10px;">
            <button class="logout-btn" onclick="adminLogout()">Logout</button>
        </div>
    </div>

    <div class="stats">
        <div class="stat-card" style="background: linear-gradient(135deg, #667eea, #764ba2);" onclick="showTab('users', event)">
            <div class="stat-label">Total Users</div>
            <div class="stat-value" id="totalUsers">0</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b, #38f9d7);" onclick="showPlayersModal()">
            <div class="stat-label">üë• Players</div>
            <div class="stat-value">üí∞</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
            <div class="stat-label">Total Withdrawals</div>
            <div class="stat-value">Rs <span id="totalWithdrawals">0</span></div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('users', event)">üë• Users</button>
        <button class="tab" onclick="showTab('deposits', event)">üí∞ Deposits</button>
        <button class="tab" onclick="showTab('withdraws', event)">üí∏ Withdrawals</button>
    </div>

    <div id="users" class="tab-content active">
        <h2 style="margin-bottom: 15px;">All Users</h2>
        <div id="usersContent"></div>
    </div>

    <div id="deposits" class="tab-content">
        <h2 style="margin-bottom: 15px;">Deposit Requests</h2>
        <div id="depositsContent"></div>
    </div>

    <div id="withdraws" class="tab-content">
        <h2 style="margin-bottom: 15px;">Withdrawal Requests</h2>
        <div id="withdrawsContent"></div>
    </div>
</div>

<!-- Players Modal -->
<div id="playersModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">üë• Players - Live Balances</div>
        <div class="players-list" id="playersContent"></div>
        <button class="btn-reject" style="width: 100%; margin-top: 20px;" onclick="closePlayersModal()">Close</button>
    </div>
</div>

<!-- Edit Balance Modal -->
<div id="editBalanceModal" class="modal">
    <div class="modal-content">
        <div class="modal-title">‚úèÔ∏è Edit Balance</div>
        <div style="margin-bottom: 20px;">
            <strong>User:</strong> <span id="editUserName"></span><br>
            <strong>Phone:</strong> <span id="editUserPhone"></span><br>
            <strong>Current Balance:</strong> Rs <span id="editCurrentBalance"></span>
        </div>
        <input type="number" id="editNewBalance" class="modal-input" placeholder="New Balance" min="0" step="0.01">
        <button class="btn-approve" style="width: 100%; margin: 10px 0;" onclick="saveBalance()">Save Balance</button>
        <button class="btn-reject" style="width: 100%;" onclick="closeModal()">Cancel</button>
    </div>
</div>

<script type="module">
// ============================================
// FIREBASE CONFIG
// ============================================
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
import { getDatabase, ref, set, get, update, remove } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

const firebaseConfig = {
    apiKey: "AIzaSyDOVSOWKPA5y4EYQa4YPQVRi3BWH6tCqn4",
    authDomain: "mines-game-e18cc.firebaseapp.com",
    databaseURL: "https://mines-game-e18cc-default-rtdb.firebaseio.com",
    projectId: "mines-game-e18cc",
    storageBucket: "mines-game-e18cc.firebasestorage.app",
    messagingSenderId: "739240698071",
    appId: "1:739240698071:web:a8a25f8a3c7f1b5f8d3e7c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

window.db = db;
window.dbRef = ref;
window.dbSet = set;
window.dbGet = get;
window.dbUpdate = update;
window.dbRemove = remove;
</script>

<script>
const ADMIN_PASSWORD = 'admin123';
let currentEditUser = null;

// ============================================
// LOGIN/LOGOUT
// ============================================
function adminLogin() {
    const password = document.getElementById('adminPassword').value;
    if (password === ADMIN_PASSWORD) {
        localStorage.setItem('adminLoggedIn', 'true');
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        loadAllData();
    } else {
        alert('‚ùå Wrong password!');
    }
}

function adminLogout() {
    if (confirm('Logout?')) {
        localStorage.removeItem('adminLoggedIn');
        location.reload();
    }
}

window.addEventListener('load', () => {
    if (localStorage.getItem('adminLoggedIn') === 'true') {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboard').classList.add('active');
        loadAllData();
    }
});

// ============================================
// DATA LOADING
// ============================================
async function loadAllData() {
    await Promise.all([
        loadUsers(),
        loadDeposits(),
        loadWithdraws(),
        updateStats()
    ]);
}

async function loadUsers() {
    try {
        const usersRef = window.dbRef(window.db, 'users');
        const snapshot = await window.dbGet(usersRef);
        const content = document.getElementById('usersContent');
        
        if (!snapshot.exists()) {
            content.innerHTML = '<div class="no-data">No users yet</div>';
            return;
        }
        
        const users = snapshot.val();
        let usersArray = Object.entries(users).map(([phone, data]) => ({...data, phone}));
        usersArray.sort((a, b) => (b.lastLogin || 0) - (a.lastLogin || 0));
        
        let html = '';
        usersArray.forEach(user => {
            const joinDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
            const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'N/A';
            
            html += `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${user.name}</div>
                            <div class="card-info">üì± ${user.phone}</div>
                            <div class="card-info">üìÖ Joined: ${joinDate}</div>
                            <div class="card-info">üïí Last Login: ${lastLogin}</div>
                            <div class="card-info">üí∞ Total Deposit: Rs ${user.totalDeposit || 0}</div>
                            <div class="card-info">üí∏ Total Withdraw: Rs ${user.totalWithdraw || 0}</div>
                        </div>
                    </div>
                    <div class="card-amount">Balance: Rs ${(user.balance || 0).toFixed(2)}</div>
                    <button class="btn-edit" onclick="editBalance('${user.phone}', '${user.name}', ${user.balance || 0})">
                        ‚úèÔ∏è Edit Balance
                    </button>
                </div>
            `;
        });
        
        content.innerHTML = html;
    } catch (error) {
        console.error('Error loading users:', error);
    }
}

async function loadDeposits() {
    try {
        const depositsRef = window.dbRef(window.db, 'depositRequests');
        const snapshot = await window.dbGet(depositsRef);
        const content = document.getElementById('depositsContent');
        
        if (!snapshot.exists()) {
            content.innerHTML = '<div class="no-data">No deposits yet</div>';
            return;
        }
        
        const deposits = snapshot.val();
        let depositsArray = Object.entries(deposits).map(([key, val]) => ({...val, firebaseKey: key}));
        depositsArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        
        let html = '';
        depositsArray.forEach(dep => {
            const date = dep.timestamp ? new Date(dep.timestamp).toLocaleString() : 'N/A';
            const statusClass = dep.status === 'pending' ? 'status-pending' : 
                               dep.status === 'approved' ? 'status-approved' : 'status-rejected';
            
            html += `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${dep.name}</div>
                            <div class="card-info">üì± ${dep.phone}</div>
                            <div class="card-info">üïí ${date}</div>
                        </div>
                        <span class="${statusClass}">${(dep.status || 'pending').toUpperCase()}</span>
                    </div>
                    <div class="card-amount">Rs ${dep.amount}</div>
                    <div style="margin-top: 10px;">
                        ${dep.status === 'pending' ? `
                            <button class="btn-approve" onclick="approveDeposit('${dep.firebaseKey}', '${dep.phone}', ${dep.amount})">‚úì Approve</button>
                            <button class="btn-reject" onclick="rejectDeposit('${dep.firebaseKey}')">‚úó Reject</button>
                        ` : ''}
                        <button class="btn-delete" onclick="deleteRequest('depositRequests', '${dep.firebaseKey}', '${dep.phone}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
        });
        
        content.innerHTML = html;
    } catch (error) {
        console.error('Error loading deposits:', error);
    }
}

async function loadWithdraws() {
    try {
        const withdrawsRef = window.dbRef(window.db, 'withdrawRequests');
        const snapshot = await window.dbGet(withdrawsRef);
        const content = document.getElementById('withdrawsContent');
        
        if (!snapshot.exists()) {
            content.innerHTML = '<div class="no-data">No withdrawals yet</div>';
            return;
        }
        
        const withdraws = snapshot.val();
        let withdrawsArray = Object.entries(withdraws).map(([key, val]) => ({...val, firebaseKey: key}));
        withdrawsArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        
        let html = '';
        withdrawsArray.forEach(wit => {
            const date = wit.timestamp ? new Date(wit.timestamp).toLocaleString() : 'N/A';
            const statusClass = wit.status === 'pending' ? 'status-pending' : 
                               wit.status === 'approved' ? 'status-approved' : 'status-rejected';
            
            html += `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">${wit.name}</div>
                            <div class="card-info">üì± ${wit.phone}</div>
                            <div class="card-info">üí∞ JazzCash: ${wit.jazzCash}</div>
                            <div class="card-info">üïí ${date}</div>
                        </div>
                        <span class="${statusClass}">${(wit.status || 'pending').toUpperCase()}</span>
                    </div>
                    <div class="card-amount">Rs ${wit.amount}</div>
                    <div style="margin-top: 10px;">
                        ${wit.status === 'pending' ? `
                            <button class="btn-approve" onclick="approveWithdraw('${wit.firebaseKey}', '${wit.phone}', ${wit.amount})">‚úì Approve</button>
                            <button class="btn-reject" onclick="rejectWithdraw('${wit.firebaseKey}')">‚úó Reject</button>
                        ` : ''}
                        <button class="btn-delete" onclick="deleteRequest('withdrawRequests', '${wit.firebaseKey}', '${wit.phone}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
        });
        
        content.innerHTML = html;
    } catch (error) {
        console.error('Error loading withdrawals:', error);
    }
}

async function updateStats() {
    try {
        // Get users
        const usersRef = window.dbRef(window.db, 'users');
        const usersSnapshot = await window.dbGet(usersRef);
        const users = usersSnapshot.exists() ? usersSnapshot.val() : {};
        
        // Calculate stats
        const totalUsers = Object.keys(users).length;
        const totalWithdrawals = Object.values(users).reduce((sum, u) => sum + (u.totalWithdraw || 0), 0);
        
        // Update UI
        document.getElementById('totalUsers').textContent = totalUsers;
        document.getElementById('totalWithdrawals').textContent = totalWithdrawals.toFixed(2);
    } catch (error) {
        console.error('Error updating stats:', error);
    }
}

// ============================================
// PLAYERS MODAL
// ============================================
async function showPlayersModal() {
    try {
        const usersRef = window.dbRef(window.db, 'users');
        const snapshot = await window.dbGet(usersRef);
        const content = document.getElementById('playersContent');
        
        if (!snapshot.exists()) {
            content.innerHTML = '<div class="no-data">No players yet</div>';
            document.getElementById('playersModal').classList.add('active');
            return;
        }
        
        const users = snapshot.val();
        let usersArray = Object.entries(users).map(([phone, data]) => ({...data, phone}));
        usersArray.sort((a, b) => (b.balance || 0) - (a.balance || 0));
        
        let html = '';
        usersArray.forEach(user => {
            html += `
                <div class="player-card">
                    <div class="player-info">
                        <div class="player-name">${user.name}</div>
                        <div class="player-phone">${user.phone}</div>
                    </div>
                    <div class="player-balance">Rs ${(user.balance || 0).toFixed(2)}</div>
                </div>
            `;
        });
        
        content.innerHTML = html;
        document.getElementById('playersModal').classList.add('active');
    } catch (error) {
        console.error('Error loading players:', error);
    }
}

function closePlayersModal() {
    document.getElementById('playersModal').classList.remove('active');
}

// ============================================
// DELETE REQUEST
// ============================================
async function deleteRequest(requestType, requestKey, phone) {
    if (!confirm('Delete this request? User will be moved to Players section.')) return;
    
    try {
        // Remove the request
        const requestRef = window.dbRef(window.db, `${requestType}/${requestKey}`);
        await window.dbRemove(requestRef);
        
        alert('‚úÖ Request deleted!');
        loadAllData();
    } catch (error) {
        console.error('Error deleting request:', error);
        alert('‚ùå Error! Try again.');
    }
}

// ============================================
// APPROVE/REJECT FUNCTIONS
// ============================================
async function approveDeposit(depositKey, phone, amount) {
    if (!confirm('Approve this deposit? User balance will be credited.')) return;
    
    try {
        // Update user balance
        const userRef = window.dbRef(window.db, `users/${phone}`);
        const userSnapshot = await window.dbGet(userRef);
        
        if (userSnapshot.exists()) {
            const userData = userSnapshot.val();
            const newBalance = (userData.balance || 0) + amount;
            const newTotalDeposit = (userData.totalDeposit || 0) + amount;
            
            await window.dbUpdate(userRef, {
                balance: newBalance,
                totalDeposit: newTotalDeposit
            });
        }
        
        // Update deposit status
        const depositRef = window.dbRef(window.db, `depositRequests/${depositKey}`);
        await window.dbUpdate(depositRef, {
            status: 'approved',
            approvedAt: Date.now()
        });
        
        alert('‚úÖ Deposit approved! User balance updated.');
        loadAllData();
    } catch (error) {
        console.error('Error approving deposit:', error);
        alert('‚ùå Error! Try again.');
    }
}

async function rejectDeposit(depositKey) {
    if (!confirm('Reject this deposit?')) return;
    
    try {
        const depositRef = window.dbRef(window.db, `depositRequests/${depositKey}`);
        await window.dbUpdate(depositRef, {
            status: 'rejected'
        });
        
        alert('Deposit rejected');
        loadAllData();
    } catch (error) {
        console.error('Error rejecting deposit:', error);
    }
}

async function approveWithdraw(withdrawKey, phone, amount) {
    if (!confirm('Step 1: Have you sent money to user?')) return;
    if (!confirm('Step 2: Confirm approval? Balance will be deducted.')) return;
    
    try {
        // Update user balance
        const userRef = window.dbRef(window.db, `users/${phone}`);
        const userSnapshot = await window.dbGet(userRef);
        
        if (userSnapshot.exists()) {
            const userData = userSnapshot.val();
            const newBalance = (userData.balance || 0) - amount;
            const newTotalWithdraw = (userData.totalWithdraw || 0) + amount;
            
            await window.dbUpdate(userRef, {
                balance: Math.max(0, newBalance),
                totalWithdraw: newTotalWithdraw
            });
        }
        
        // Update withdrawal status
        const withdrawRef = window.dbRef(window.db, `withdrawRequests/${withdrawKey}`);
        await window.dbUpdate(withdrawRef, {
            status: 'approved',
            approvedAt: Date.now()
        });
        
        alert('‚úÖ Withdrawal approved! User balance deducted.');
        loadAllData();
    } catch (error) {
        console.error('Error approving withdrawal:', error);
        alert('‚ùå Error! Try again.');
    }
}

async function rejectWithdraw(withdrawKey) {
    if (!confirm('Reject this withdrawal?')) return;
    
    try {
        const withdrawRef = window.dbRef(window.db, `withdrawRequests/${withdrawKey}`);
        await window.dbUpdate(withdrawRef, {
            status: 'rejected'
        });
        
        alert('Withdrawal rejected');
        loadAllData();
    } catch (error) {
        console.error('Error rejecting withdrawal:', error);
    }
}

// ============================================
// EDIT BALANCE
// ============================================
function editBalance(phone, name, balance) {
    currentEditUser = phone;
    document.getElementById('editUserName').textContent = name;
    document.getElementById('editUserPhone').textContent = phone;
    document.getElementById('editCurrentBalance').textContent = balance.toFixed(2);
    document.getElementById('editNewBalance').value = balance.toFixed(2);
    document.getElementById('editBalanceModal').classList.add('active');
}

async function saveBalance() {
    const newBalance = parseFloat(document.getElementById('editNewBalance').value);
    
    if (isNaN(newBalance) || newBalance < 0) {
        alert('Invalid balance!');
        return;
    }
    
    try {
        const userRef = window.dbRef(window.db, `users/${currentEditUser}`);
        await window.dbUpdate(userRef, {
            balance: newBalance
        });
        
        alert('‚úÖ Balance updated!');
        closeModal();
        loadAllData();
    } catch (error) {
        console.error('Error updating balance:', error);
        alert('‚ùå Error! Try again.');
    }
}

// ============================================
// UI FUNCTIONS
// ============================================
function closeModal() {
    document.getElementById('editBalanceModal').classList.remove('active');
}

function showTab(tabName, event) {
    if (event) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if (event.target.classList.contains('tab')) {
            event.target.classList.add('active');
        }
    }
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
}

// Make functions global
window.adminLogin = adminLogin;
window.adminLogout = adminLogout;
window.loadAllData = loadAllData;
window.showPlayersModal = showPlayersModal;
window.closePlayersModal = closePlayersModal;
window.deleteRequest = deleteRequest;
window.approveDeposit = approveDeposit;
window.rejectDeposit = rejectDeposit;
window.approveWithdraw = approveWithdraw;
window.rejectWithdraw = rejectWithdraw;
window.editBalance = editBalance;
window.saveBalance = saveBalance;
window.closeModal = closeModal;
window.showTab = showTab;

// Auto-refresh every 30 seconds
setInterval(loadAllData, 30000);
</script>

</body>
</html>
